<!DOCTYPE html>
<html>
  <head>
    <title>PsychExp</title>    
    <script src="https://unpkg.com/jspsych@7.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.0"></script>
    <link href="https://unpkg.com/jspsych@7.1.2/css/jspsych.css" rel="stylesheet" type="text/css" />
    <script src="factorial_noRandom.js"></script>
    <script src="make_condition.js"></script>
    <script src="make_stim_position.js"></script>
    <script src="jspsych-psychophysics.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.2/underscore-min.js" integrity="sha512-anTuWy6G+usqNI0z/BduDtGWMZLGieuJffU89wUU7zwY/JhmDzFrfIZFA3PY7CEX4qxmn3QXRoXysk6NBh5muQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
      #basic_arena {
        position: relative;
        margin: auto;              
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        width: 1000px;
        height: 800px;                
        display: flex;
        align-items: center;                
        border: 1px solid black;
      }
      img {
        width: 84px;
        height: 84px;
        position: absolute;
        display: flex; 
      }
    </style>
  </head>
  <body></body>
  <script>
    // condition   
    var factors = {
      dist: [11],
      set_size: [3,4,6,8],
      target_ox: [0,1], // 0=target absent, 1=target present
      dimension: [-1,1],
      direction: [-1,1]
    }
    var cond_list = factorial_noRandom(factors);
    var target_coord = '0_0';
    var jitter = [-1,0,1];
    var n_block = 4;
    var stim_dir = 'stimuli/bedroom11_ver4_d0.5/'
    var position_idx = _.range(0,_.max(factors.set_size));
    var exp_cond = make_condition(cond_list, jitter, target_coord, n_block, stim_dir, position_idx);

    const jsPsych = initJsPsych(); 
   
    // img positions
    var max_set_size=8;
    var radius=200;
    var stim_size = 84;
    var start_XYs = [];
    var cx = 500;
    var cy = 400;
    var angles = _.range(0, 2*Math.PI, (2*Math.PI/max_set_size));  
    var jitters = [0,10,20];
    var jittered_angles = _.map(angles, function(x){return x + _.sample(jitters,1*Math.PI/180)})    
    for (var i in jittered_angles){      
      var x = cx + (Math.cos(i)*radius);
      var y = cy + (Math.sin(i)*radius);
      start_XYs.push([x,y]);
    }

    // draw function
    function prepare_stim(condition, predefined_position){
      // var stim = new Array(8);
      // read in condition
      var set_size=condition['set_size']      
      var stim_pos=condition['stim_position']     
      var target_ox=condition['target_ox']
      var target_path=condition['target_path']
      console.log(target_path)
      var nt_path=condition['nt_path']
      var stim_path = nt_path;      
      if(target_ox==1){
        stim_path = nt_path.concat(target_path);       
      }
      // make    
      var stim=[];  
      for (var i=0; i<set_size; i++){
        stim.push({
          obj_type: 'image',
          file: stim_path[i],
          image_width: stim_size,
          startX: predefined_position[i][0],
          startY: predefined_position[i][1]          
        })
      }       
      return stim;  
    }
    var stim_list = prepare_stim(exp_cond[0][0],start_XYs)
    console.log(stim_list)
    

    var trial = {
      type: jsPsychPsychophysics,
      stimuli: stim_list,
      choices: ['y', 'n'], 
      canvas_width: 1000,
      canvas_height: 800,
      // background_color: '#ffffff'
    }
    
    var trial_procedure = {
      timeline: [trial],
      timeline_variables: exp_cond[0]
    }   
    

    jsPsych.run([trial_procedure]);
  </script>
</html>